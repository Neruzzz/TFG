# TTX

Getting data from a Dusty Manager module using MQTT.

## Getting started

### Prerequisites
Be sure you have the following hardware:

* nRF9160 DK: https://www.nordicsemi.com/Software-and-Tools/Development-Kits/nRF9160-DK
* Two or more LTP5901 chips (1 Dusty module acting as Manager and the others acting as motes)

### Installation
* Download and install nRF Connect for Desktop from here: https://www.nordicsemi.com/Software-and-tools/Development-Tools/nRF-Connect-for-desktop/Download#infotabs

* Open ``nRF Connect for Desktop``

* Install ``Toolchain Manager``

* Install `Programmer`

* Open ``Toolchain Manager``

* Install the v1.3.0 nRF Connect SDK from the list (this will install both SDK and Segger Embedded Studio (SES) IDE automatically)
	
* Download application and modem firmwares from https://www.nordicsemi.com/Software-and-tools/Development-Kits/nRF9160-DK/Download

* Follow these steps to update application and modem firmwares:
    * App firmware steps: https://infocenter.nordicsemi.com/topic/ug_nrf91_dk_gsg/UG/nrf91_DK_gsg/updating_application_firmware.html
    * Modem firmware steps: https://infocenter.nordicsemi.com/topic/ug_nrf91_dk_gsg/UG/nrf91_DK_gsg/updating_modem_firmware.html

## Deployment

First of all, we must program the nRF52840 board controller integrated into the nRF9160DK SiP.

* Select ``nRF52`` on the **PROG/DEBUG** switch (SW5) from the nRF9160DK board.

* Open ``nRF52840_sample_route_uart_to_GPIO`` project folder on Segger Embedded Studio.
     * Open **Segger Embedded Studio** (SES) from **Toolchain Manager**
    * Go to **File**
    * Go to **Open nRF Connect SDK Project**
    * In **CMakeLists.txt** field, select the ``CMakeLists.txt`` file from this project folder.
    * In **Board Directory** field, select  ``nrf9160dk_nrf52840``
    * In **Board Name** field, select ``nrf9160dk_nrf52840``
    * Click **OK**

* Build and Run the project.

* Now UART2 pins are routed from VCOM2 port to the following nRF9160 DK external GPIO pins:
     * P0.15 -> RTS
     * P0.14 -> CTS
     * P0.00 -> TXD   *(info enters to the nRF9160 through this pin)*
     * P0.01 -> RXD 
     
Now it's time to program the nRF9160DK chip.

* Go to [nRF9160_dusty_over_mqtt README file](nRF9160_dusty_over_mqtt/README.md) to see how to set the appropriate configuration parameters.

* Select ``nRF91`` on the **PROG/DEBUG** switch (SW5) from the nRF9160DK board.

* Open ``nRF9160_dusty_over_mqtt`` project folder on Segger Embedded Studio.
    * Open **Segger Embedded Studio** (SES) from **Toolchain Manager**
    * Go to **File**
    * Go to **Open nRF Connect SDK Project**
    * In **CMakeLists.txt** field, select the ``CMakeLists.txt`` file from this project folder.
    * In **Board Directory** field, select  ``nrf9160dk_nrf9160``
    * In **Board Name** field, select ``nrf9160dk_nrf9160ns``
    * Click **OK**

* Build and Run the project.
    * To connect to MQTT Broker over TLS, follow [these steps](https://github.com/wine-uoc/ttx/tree/master/nRF9160_dusty_over_mqtt#configure-tls-for-mqtt) 	instead.
* Now, the project should be running on the nRF9160 board successfully.

# Packet format

The format of the sent packet from the Dusty manager to the MQTT endpoint is as follows:

```yaml
{
    "name": "notifData",
    "fields": {
        "macAddress": "00-17-0d-00-00-XX-XX-XX",
        "data": [byte_1, byte_2, ... ,byte_n]
    },
    "gateway": "uoc-1",
    "timestamp": YYYYYYYYY
}
```
Where:

* ```byte_1, bytes_2, ... ,byte_n``` are data generated by a Dusty mote.
* ```XX-XX-XX``` are the last 3 bytes from the MAC address of the dusty mote which generated the data.
* ```YYYYYYYYY``` is the Unix epoch time from when the packet was generated.
